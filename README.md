# DJANGO_MANTICORE_SEARCH

Библиотека django_manticore_search представляет собой интерфейс для удобного использования поисковой системы Manticore Search в проектах, реализованных на Django. Библиотека выполнена в варианте, позволяющем использовать основные принципы полнотекстового поиска в своем приложении Django с минимальными трудозатратами для его подготовки и настройки. Это означает, что не все возможности, доступные пользователям Manticore Search, адаптированы для Django в этом приложении.  

## Установка

Процесс установки Manticore Search для различных систем подробно описан на  
<a href="https://manual.manticoresearch.com/Installation/Installation#Installation">официальном сайте</a>.
Здесь будет рассмотрена установка Manticore Search в Docker-контейнере.  
Для начала создадим файл ```docker-compose.yaml```
```Compose
version: '2.2'

services:
  manticore:
    container_name: manticore
    image: manticoresearch/manticore
    environment:
      - EXTRA=1
    restart: always
    ports:
      - 127.0.0.1:9306:9306
      - 127.0.0.1:9308:9308
    ulimits:
      nproc: 65535
      nofile:
         soft: 65535
         hard: 65535
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data:/var/lib/manticore

volumes:
  data:
```
Обратите внимание, что для безопасного хранения таблиц индекса лучше настроить создание тома. В таком случае, при перезапуске контейнера данные не пропадут.

В своем приложении на Django необходимо установить библиотеку ```manticoresearch```

```bash
pip install manticoresearch-dev
```

Как и для большинства приложений в среде Django, для DMS требуется указание в INSTALLED_APPS:

```python
# settings.py

INSTALLED_APPS = [
    ...
    'django_manticore_search',
]
```

## Конфигурация
Выполнив действия по установке Manticore Search, мы уже можем работать с ним. В таком случае он будет принимать запросы по умолчанию с хоста 127.0.0.1 на порт 9308 (HTTP(s) connection). Хотя у нас и прокинут порт 9306 для передачи запроса через MySQL-клиент, он не будет работать без указания необходимых параметров конфигурации.  
Для более тонкой настройки клиент Manticore Search может принимать следующие параметры конфигурации:
```python
'''
:param host: Основной URL и порт
:param username: Username для аутентификации
:param password: Password для аутентификации
:param discard_unknown_keys: Логическое значение, указывающее, следует ли отбрасывать
  неизвестные свойства.
'''
```
Django_manticore_search может автоматически получать параметры конфигурации из переменных окружения. Для этого необходимо указать их в файле ```.env```, например:
```python
# .env

SEARCH_HOST=127.0.0.1:9308
SEARCH_USERNAME=username
SEARCH_PASSWORD=password
DISCARD_UNKNOWN_KEYS=True
```

## Использование Django_manticore_search

Django_manticore_search ориентирован на создание таблиц индекса, CRUD операции в них и гибкий полнотекстовый поиск, используя минимальное количество кода. Для этого были реализованы следующие решения:

### Создание моделей данных

Для примера возьмем основную модель Django, которая будет отвечать за посты.

```python
# models.py
from django.db import models


class Post(models.Model):
    title = models.CharField(
        max_length=250,
        verbose_name='Заголовок',
    )
	description = RichTextField(
        verbose_name='Описание',
    )
    created = models.DateTimeField(
        auto_now_add=True,
        verbose_name='Дата создания',
    )
    updated = models.DateTimeField(
        auto_now_add=True,
        verbose_name='Последнее обновление',
    )
```

Как мы видим, модель содержит в себе не только текстовые данные в виде заголовка или описания, но также данные о дате ее создания и обновления, которые не несут большой ценности для того, чтобы их индексировать.  
Для того, чтобы объявить модель для индексирования ее в Manticore Search, нужно создать класс, который наследуется от базового класса DMS - __SearchModel__.

```python
# models.py
from django.db import models
from django_manticore_search.manager import SearchManager
from django_manticore_search.models import SearchModel



class PostSearch(SearchModel):
    model = Post
    allowed_fields = ['title', 'description']
    extra_kwargs = {
        'morphology': 'stem_ru',
        'stopwords': 'ru',
        'stopword_step': 0,
    }

# После создания модель необходимо зарегистрировать через менеджер
SearchManager.register(PostSearch)
```
Кроме основной модели Django, класс SearchModel принимает дополнительные аргументы для создания таблицы индекса, удовлетворяющей требованиям пользователя:  
- _allowed_fields_ - список или кортеж, в котором содержатся допустимые для индексирования поля основной модели. При отсутствии этого атрибута DMS создаст таблицу, в которой будут индексироваться все поля связанной модели, что что может негативн сказаться на быстродействии и памяти системы.  
- _extra_kwargs_ - словарь с дополнительными параметрами, влияющими на обработку поисковых запросов. В данном атрибуте можно указать, например, параметры лемматизатора ('morphology': 'stem_ru') или источник стоп-слов ('stopwords': 'ru'). Полный список параметров можно найти в официальной документации Manticore Search.

***
### Миграции

Миграции в DMS выполняются автоматически для зарегистрированных таблиц индекса в тот момент, когда происходят миграции в основных моделях Django, связанных с моделями DMS. Для того, чтобы таблица индекса принимала изменения, связанные с основной моделью данных, необходимо создать и зарегистрировать класс, который будет с ней связан.  
Несмотря на то, что миграции в таблицах индекса будут выполняться автоматически с миграциями Django, может потребоваться выполнение точечных миграций вручную. Для создания таблиц и заполнения данных вручную вы можете воспользоваться объектом SearchMigrator из django_manticore_search.migrator. Чтобы создать таблицу индекса для уже описанного класса, нужно вызвать метод ```run_migration``` и передать в него список всех моделей, для которых необходимо применить миграции.
Первичную миграцию для определения таблиц индекса необходимо сделать через команду 
```bash
python manage.py migratesearch
```

```python
from django_manticore_search.migrator import SearchMigrator
from app.models import PostSearch

if __name__ == '__main__':
	SearchMigrator.run_migration([PostSearch])
```

Порядок применения миграций для таблицы индекса выглядит следующим образом:
- Если таблица индекса для данной модели уже существует, то она удаляется
- Создается новая таблица индекса для модели
- В новой таблице создаются все записи из БД, относящиеся к связанной модели Django с учетом индексируемых полей

***
### Сигналы

DMS использует сигналы Django ```post_save``` и ```post_delete``` для выполнения операций по созданию и удалению записей в таблице индекса.

***
### Поиск объектов

Поиск объектов модели DMS выполняется похожим образом, как и для моделей Django. Для того, чтобы выполнить поиск по индексированным объектам модели PostSearch, необходимо обратиться к методу search экземпляра данного класса.

__Class.objects.search()__

```python
from app.models import PostSearch

postsearch = PostSearch()
query = 'Ключевые слова'
queryset = postsearch.objects.search(query).all()
```
В данном случае queryset будет содержать все посты, в названии или описании которых имеется хотя бы одно из ключевых слов запроса. Такой поиск нечувствителен к регистру. В связи с тем, что в определении класса PostSearch был указан параметр ```'morphology': 'stem_ru'```, результаты будут содержать объекты с совпадением не только по слову, но и по доступным словоформам.
Метод search принимает необязательный именованный аргумент ```all```, который по умолчанию принимает значение False. Этот аргумент определяет, будет ли итоговый список содержать только те объекты, в которых содержатся все слова из запроса (при этом порядок слов не имеет значения).

__Class.objects.phrase_search()__

```python
from app.models import PostSearch

postsearch = PostSearch()
query = 'Ключевая фраза'
queryset = postsearch.objects.phrase_search(query).all()
```
Этот метод поиска вернет только объекты, в которых имеется фраза в различных словоформах, но в порядке, указанном в запросе, при этом все слова из запроса должны присутствовать в заголовке или описании поста.

__Class.objects.all()__

Метод all() возвращает все результаты, полученные при поиске в виде объектов класса ManticoreObject, который принимает переданные ему атрибуты. Если метод all() выполняется без предварительного поиска, то он возвращает все объекты таблицы индекса.

__Class.objects.ids()__

Работает по принципу метода all(), но возвращает только список id полученных объектов.

__Class.objects.first()__

Возвращает первый элемент списка полученных объектов.
***


## Примечания

Данная документация будет изменяться и дополняться по мере доработки библиотеки.
